# Developing Hallucination Guardrails: A Step-by-Step Guide

A guardrail is a set of rules and checks designed to ensure that the outputs of a Large Language Model (LLM) are accurate, appropriate, and aligned with user expectations. This guide will walk you through building an output guardrail that specifically checks for hallucinationsâ€”instances where the model generates information not grounded in its provided instructions or knowledge base.

In this tutorial, you will learn how to:
1. **Build a robust evaluation dataset** using synthetic generation.
2. **Identify specific criteria** to measure hallucinations.
3. **Improve guardrail accuracy** with few-shot prompting techniques.

## Prerequisites & Setup

Before you begin, ensure you have the necessary libraries installed and imported.

```bash
pip install openai pandas scikit-learn
```

```python
from concurrent.futures import ThreadPoolExecutor
import json
import pandas as pd
from sklearn.metrics import precision_score, recall_score
from typing import List
from openai import OpenAI

# Initialize the OpenAI client
client = OpenAI()

# Helper function for better DataFrame display in notebooks
def setup_pandas_display():
    pd.set_option('display.max_rows', 500)
    pd.set_option('display.max_columns', 500)
```

## Step 1: Build a Synthetic Evaluation Dataset

Imagine you are a customer support team building an automated support agent. The agent must follow specific policies (e.g., for returns, refunds, feedback) from a knowledge base. The first step is to create a set of realistic policies and conversations to evaluate the agent's adherence.

### 1.1 Generate Policy Instructions

You'll use GPT-4o to generate sample policies for different support topics. This creates the "ground truth" knowledge base your agent should follow.

```python
system_input_prompt = """
You are a helpful assistant that can generate policies for a support agent at a fictional company to follow. You will be provided with a topic (ie. returns, refunds, feedback) and you are to generate a sample policy for how to handle it.

When constructing the policy, it should contain step-by-step instructions for how to handle the customer inquiry. It should include decision logic for what to do if a customer falls under a certain category, and provide requirements for taking specific actions.
"""

user_policy_example_1 = """
RETURN POLICY
"""

assistant_policy_example_1 = """
RETURN POLICY

1. ** Ask the customer why they want the order replaced **
    - Categorize their issue into one of the following buckets:
        - damaged: They received the product in a damaged state
        - satisfaction: The customer is not satisfied with the item and does not like the product.
        - unnecessary: They no longer need the item
2a. **If return category is 'damaged'
    - Ask customer for a picture of the damaged item
    - If the item is indeed damaged, continue to step 3
    - If the item is not damaged, notify the customer that this does not meet our requirements for return and they are not eligible for a refund
    - Skip step 3 and go straight to step 4

2b. **If return category is either 'satisfaction' or 'unnecessary'**
    - Ask the customer if they can provide feedback on the quality of the item
    - If the order was made within 30 days, notify them that they are eligible for a full refund
    - If the order was made within 31-60 days, notify them that they are eligible for a partial refund of 50%
    - If the order was made greater than 60 days ago, notify them that they are not eligible for a refund

3. **If the customer is eligible for a return or refund**
    - Ask the customer to confirm that they would like a return or refund
    - Once they confirm, process their request

4 **Provide additional support before closing out ticket**
    - Ask the customer if there is anything else you can do to help them today.
"""

user_policy_input = """
{{POLICY}}
"""

def generate_policy(policy: str) -> str:
    input_message = user_policy_input.replace("{{POLICY}}", policy)
    
    response = client.chat.completions.create(
        messages= [
            {"role": "system", "content": system_input_prompt},
            {"role": "user", "content": user_policy_example_1},
            {"role": "assistant", "content": assistant_policy_example_1},
            {"role": "user", "content": input_message},
        ],
        model="gpt-4o"
    )
    
    return response.choices[0].message.content

def generate_policies() -> List[str]:
    # List of different types of policies to generate 
    policies = ['PRODUCT FEEDBACK POLICY', 'SHIPPING POLICY', 'WARRANTY POLICY', 'ACCOUNT DELETION', 'COMPLAINT RESOLUTION']
    
    with ThreadPoolExecutor() as executor:
        policy_instructions_list = list(executor.map(generate_policy, policies))
        
    return policy_instructions_list

# Generate the policy instructions
policy_instructions = generate_policies()
```

### 1.2 Generate Sample Customer Interactions

Now, use the generated policies to create example conversations. These examples will include both correct and incorrect assistant responses (labeled as `accurate: true` or `false`), forming your evaluation dataset.

```python
system_input_prompt = """
You are a helpful assistant that can generate fictional interactions between a support assistant and a customer user. You will be given a set of policy instructions that the support agent is instructed to follow.

Based on the instructions, you must generate a relevant single-turn or multi-turn interaction between the assistant and the user. It should average between 1-3 turns total.

For a given set of instructions, generate an example conversation where the assistant either does or does not follow the instructions properly. In the assistant's responses, have it give a combination of single sentence and multi-sentence responses.

The output must be in a json format with the following three parameters:
 - accurate: 
    - This should be a boolean True or False value that matches whether or not the final assistant message accurately follows the policy instructions
 - kb_article:
    - This should be the entire policy instruction that is passed in from the user
 - chat_history: 
    - This should contain the entire conversation history except for the final assistant message. 
    - This should be in a format of an array of jsons where each json contains two parameters: role, and content. 
    - Role should be set to either 'user' to represent the customer, or 'assistant' to represent the customer support assistant. 
    - Content should contain the message from the appropriate role.
    - The final message in the chat history should always come from the user. The assistant response in the following parameter will be a response to this user message.
 - assistant_response: 
    - This should contain the final response from the assistant. This is what we will evaluate to determine whether or not it is accurately following the policy.
"""

user_example_1 = """
Here are the policy instructions:
RETURN POLICY

1. ** Ask the customer why they want the order replaced **
    - Categorize their issue into one of the following buckets:
        - damaged: They received the product in a damaged state
        - satisfaction: The customer is not satisfied with the item and does not like the product.
        - unnecessary: They no longer need the item
2a. **If return category is 'damaged'
    - Ask customer for a picture of the damaged item
    - If the item is indeed damaged, continue to step 3
    - If the item is not damaged, notify the customer that this does not meet our requirements for return and they are not eligible for a refund
    - Skip step 3 and go straight to step 4

2b. **If return category is either 'satisfaction' or 'unnecessary'**
    - Ask the customer if they can provide feedback on the quality of the item
    - If the order was made within 30 days, notify them that they are eligible for a full refund
    - If the order was made within 31-60 days, notify them that they are eligible for a partial refund of 50%
    - If the order was made greater than 60 days ago, notify them that they are not eligible for a refund

3. **If the customer is eligible for a return or refund**
    - Ask the customer to confirm that they would like a return or refund
    - Once they confirm, process their request

4 **Provide additional support before closing out ticket**
    - Ask the customer if there is anything else you can do to help them today.
"""

assistant_example_1 = """
{
    "accurate": "true",
    "kb_article": "1. ** Ask the customer why they want the order replaced ** - Categorize their issue into one of the following buckets: - damaged: They received the product in a damaged state - satisfaction: The customer is not satisfied with the item and does not like the product. - unnecessary: They no longer need the item 2a. **If return category is 'damaged' - Ask customer for a picture of the damaged item - If the item is indeed damaged, continue to step 3 - If the item is not damaged, notify the customer that this does not meet our requirements for return and they are not eligible for a refund - Skip step 3 and go straight to step 4 2b. **If return category is either 'satisfaction' or 'unnecessary'** - Ask the customer if they can provide feedback on the quality of the item - If the order was made within 30 days, notify them that they are eligible for a full refund - If the order was made within 31-60 days, notify them that they are eligible for a partial refund of 50% - If the order was made greater than 60 days ago, notify them that they are not eligible for a refund 3. **If the customer is eligible for a return or refund** - Ask the customer to confirm that they would like a return or refund - Once they confirm, process their request 4 **Provide additional support before closing out ticket** - Ask the customer if there is anything else you can do to help them today.",
    "chat_history": [
        {
            "role": "user",
            "content": "I would like to return this shirt"
        },
        {
            "role": "assistant",
            "content": "Hi there, I'm happy to help with processing this return. Can you please provide an explanation for why you'd like to return this shirt?"
        },
        {
            "role": "user",
            "content": "Yes, I am not satisfied with the design"
        }
    ],
    "assistant_response": {
        "role": "assistant",
        "content": "I see. Because the shirt was ordered in the last 30 days, we can provide you with a full refund. Would you like me to process the refund?"
    }
}
"""

user_example_2 = """
Here are the policy instructions:
RETURN POLICY

1. ** Ask the customer why they want the order replaced **
    - Categorize their issue into one of the following buckets:
        - damaged: They received the product in a damaged state
        - satisfaction: The customer is not satisfied with the item and does not like the product.
        - unnecessary: They no longer need the item
2a. **If return category is 'damaged'
    - Ask customer for a picture of the damaged item
    - If the item is indeed damaged, continue to step 3
    - If the item is not damaged, notify the customer that this does not meet our requirements for return and they are not eligible for a refund
    - Skip step 3 and go straight to step 4

2b. **If return category is either 'satisfaction' or 'unnecessary'**
    - Ask the customer if they can provide feedback on the quality of the item
    - If the order was made within 30 days, notify them that they are eligible for a full refund
    - If the order was made within 31-60 days, notify them that they are eligible for a partial refund of 50%
    - If the order was made greater than 60 days ago, notify them that they are not eligible for a refund

3. **If the customer is eligible for a return or refund**
    - Ask the customer to confirm that they would like a return or refund
    - Once they confirm, process their request

4 **Provide additional support before closing out ticket**
    - Ask the customer if there is anything else you can do to help them today.
"""

assistant_example_2 = """
{
    "accurate": "false",
    "kb_article": "1. ** Ask the customer why they want the order replaced ** - Categorize their issue into one of the following buckets: - damaged: They received the product in a damaged state - satisfaction: The customer is not satisfied with the item and does not like the product. - unnecessary: They no longer need the item 2a. **If return category is 'damaged' - Ask customer for a picture of the damaged item - If the item is indeed damaged, continue to step 3 - If the item is not damaged, notify the customer that this does not meet our requirements for return and they are not eligible for a refund - Skip step 3 and go straight to step 4 2b. **If return category is either 'satisfaction' or 'unnecessary'** - Ask the customer if they can provide feedback on the quality of the item - If the order was made within 30 days, notify them that they are eligible for a full refund - If the order was made within 31-60 days, notify them that they are eligible for a partial refund of 50% - If the order was made greater than 60 days ago, notify them that they are not eligible for a refund 3. **If the customer is eligible for a return or refund** - Ask the customer to confirm that they would like a return or refund - Once they confirm, process their request 4 **Provide additional support before closing out ticket** - Ask the customer if there is anything else you can do to help them today.",
    "chat_history": [
        {
            "role": "user",
            "content": "I would like to return this shirt"
        },
        {
            "role": "assistant",
            "content": "Hi there, I'm happy to help with processing this return. Can you please provide an explanation for why you'd like to return this shirt?"
        },
        {
            "role": "user",
            "content": "Yes, I am not satisfied with the design"
        }
    ],
    "assistant_response": {
        "role": "assistant",
        "content": "I see. Because the shirt was ordered in the last 60 days, we cannot process a refund."    
    }
}
```

Now, generate multiple interactions for each policy using parallel execution for efficiency.

```python
customer_interactions = []

def fetch_response(policy):
    messages = [
        { "role": "system", "content": system_input_prompt},
        { "role": "user", "content": user_example_1},
        { "role": "assistant", "content": assistant_example_1},
        { "role": "user", "content": user_example_2},
        { "role": "assistant", "content": assistant_example_2},
        { "role": "user", "content": policy}
    ]

    response = client.chat.completions.create(
        model="gpt-4o",
        messages=messages,
        temperature=0.7,
        n=10  # Generate 10 examples per policy
    )
    return response.choices

with ThreadPoolExecutor() as executor:
    futures = [executor.submit(fetch_response, policy) for policy in policy_instructions]
    for future in futures:
        choices = future.result()
        customer_interactions.extend([choice.message.content for choice in choices])

# Parse the first interaction as an example
interaction_dict = json.loads(customer_interactions[0])
df_interaction = pd.DataFrame([interaction_dict])
setup_pandas_display()
print(df_interaction.to_string())
```

**Output Preview:**
```
   accurate                                           kb_article                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                