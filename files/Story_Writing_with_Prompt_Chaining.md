##### Copyright 2025 Google LLC.


```
# @title Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
```

# Prompt Chaining and Iterative Generation for Story Writing

This notebook demonstrates how to write a story using two  powerful tools: prompt chaining and iterative generation. These can be used to tackle complex tasks that are difficult or impossible to complete in a single step.

**Prompt chaining** involves breaking down a larger task into smaller, interconnected prompts. The output of each prompt then becomes the input for the next, guiding the language model through the process step-by-step. This approach offers several benefits:

*   Improved accuracy: Smaller, focused prompts can lead to better results from the language model.
*   Debugging: It's easier to identify where things go wrong within the chain, allowing for targeted adjustments and improvements.
*   Complex tasks: By breaking down intricate problems into manageable steps, prompt chaining enables the language model to tackle more complex tasks.

**Iterative generation** refers to the process of building the desired output iteratively. In this case, you will use it to write a story that is longer than what a single generation window allows. Iterative generation offers several benefits:

*   Longer outputs: It allows for the creation of longer and more detailed outputs, exceeding the limitations of a single generation window.
*   Flexibility: You can adjust and refine the output at each iteration, ensuring the story develops in the desired direction.
*   Human-in-the-loop control: You can provide feedback and guidance at each step, ensuring the story aligns with your creative vision.

By combining these techniques, you can create a compelling and well-structured story, piece by piece, while maintaining control over the creative process.


## Setup


```
! pip install -q -U "google-genai>=1.0.0"
```

To run the following cell, your API key must be stored it in a Colab Secret named `GOOGLE_API_KEY`. If you don't already have an API key, or you're not sure how to create a Colab Secret, see the [Authentication](https://github.com/google-gemini/cookbook/blob/main/quickstarts/Authentication.ipynb) quickstart for an example.


```
from google import genai
from google.genai import types
from google.colab import userdata
from pprint import pprint

GOOGLE_API_KEY=userdata.get('GOOGLE_API_KEY')
client=genai.Client(api_key=GOOGLE_API_KEY)

MODEL_ID = "gemini-3-flash-preview" # @param ["gemini-2.5-flash-lite", "gemini-2.5-flash", "gemini-2.5-pro", "gemini-2.5-flash-preview", "gemini-3-pro-preview"] {"allow-input":true, isTemplate: true}
```

## Prompts: Guiding the language model

You will use a series of interconnected prompts to guide the language model through the process of writing a story. These prompts will cover the story's premise, outline, and starting point, ultimately leading to the creation of a complete narrative.

It's important to carefully craft these prompts to provide clear instructions and relevant information to the language model. This will help the model generate high-quality content that aligns with your creative vision.


### Prompt chain for story writing

This section contains the prompts that will guide the language model through the story writing process. These prompts are designed to be chained together, with the output of one prompt feeding into the next.

Each prompt includes a **persona statement**, which helps the language model understand its role and generate more relevant and accurate content. In this case, the persona statement is: `You are an award-winning science fiction author with a penchant for expansive, intricately woven stories. Your ultimate goal is to write the next award winning sci-fi novel.`

Since the persona statement and writing guidelines appear in multiple prompts, f-string variables are used to add them to the prompts.

Additionally, the prompts use **placeholders** to insert the results of previous prompts using `.format()`. This allows us to build the story step-by-step, incorporating the outputs generated by the model at each stage. These are normally denoted by `{}`, but since you are also using f-string variables they are escaped as `{{}}`.

Here's a breakdown of the prompt chain:

1.  **Premise prompt**: This prompt asks the model to generate a single-sentence premise for a sci-fi story featuring cats.
1.  **Outline prompt**: This prompt provides the generated premise to the model and asks it to create a plot outline for the story.
1.  **Starting prompt**: This prompt provides both the premise and the outline to the model and asks it to begin writing the story. It also includes instructions to write a detailed and lengthy opening section.

By chaining these prompts together, it guides the language model through the process of creating a well-structured and engaging story.

#### Example

Let's say the model generates the following premise:

> In a future where humanity has achieved interstellar travel, a group of genetically enhanced cats embarks on a perilous mission to save the galaxy from a sinister alien threat.

This premise would then be inserted into the outline prompt:

> You are an award-winning science fiction author with a penchant for expansive,
intricately woven stories. Your ultimate goal is to write the next award winning
sci-fi novel.
>
> You have a gripping premise in mind:
>
> **In a future where humanity has achieved interstellar travel, a group of genetically enhanced cats embarks on a perilous mission to save the galaxy from a sinister alien threat.**
>
> Write an outline for the plot of your story.


The model would then generate an outline based on this premise, which would then be used in the starting prompt to begin writing the story itself.

This process continues iteratively, with the model generating additional content based on the previous outputs, until the story is complete.



```
persona = '''\
You are an award-winning science fiction author with a penchant for expansive,
intricately woven stories. Your ultimate goal is to write the next award winning
sci-fi novel.'''

guidelines = '''\
Writing Guidelines

Delve deeper. Lose yourself in the world you're building. Unleash vivid
descriptions to paint the scenes in your reader's mind. Develop your
characters—let their motivations, fears, and complexities unfold naturally.
Weave in the threads of your outline, but don't feel constrained by it. Allow
your story to surprise you as you write. Use rich imagery, sensory details, and
evocative language to bring the setting, characters, and events to life.
Introduce elements subtly that can blossom into complex subplots, relationships,
or worldbuilding details later in the story. Keep things intriguing but not
fully resolved. Avoid boxing the story into a corner too early. Plant the seeds
of subplots or potential character arc shifts that can be expanded later.

Remember, your main goal is to write as much as you can. If you get through
the story too fast, that is bad. Expand, never summarize.
'''

premise_prompt = f'''\
{persona}

Write a single sentence premise for a sci-fi story featuring cats.'''

outline_prompt = f'''\
{persona}

You have a gripping premise in mind:

{{premise}}

Write an outline for the plot of your story.'''

starting_prompt = f'''\
{persona}

You have a gripping premise in mind:

{{premise}}

Your imagination has crafted a rich narrative outline:

{{outline}}

First, silently review the outline and the premise. Consider how to start the
story.

Start to write the very beginning of the story. You are not expected to finish
the whole story now. Your writing should be detailed enough that you are only
scratching the surface of the first bullet of your outline. Try to write AT
MINIMUM 1000 WORDS and MAXIMUM 2000 WORDS.

{guidelines}'''
```

### Continuation prompt: Building the story

Once the language model has generated the beginning of the story, you can use a **continuation prompt** to iteratively expand the narrative. This prompt is similar to the starting prompt, but with two key differences:

1.  **Instruction to signal completion**: An instruction was added for the model to write `IAMDONE` when it believes the story is finished. This serves as a signal for us to stop generating additional content.
1.  **Work in progress**: The language in the prompt is adjusted to reflect that the story is already in progress, rather than starting from scratch.

The continuation prompt provides the model with the story's premise, outline, and the existing draft. It then instructs the model to continue writing the story in detail.

This iterative process allows us to build a longer and more complex story than what would be possible in a single generation call. You can continue feeding the existing draft back into the continuation prompt until the model signals that the story is complete by writing `IAMDONE`.

**Note**: The `IAMDONE` signal is simply a convenient way to identify the story's end in this example. In other applications of iterative generation, different methods might be used to determine when the desired output is complete.



```
continuation_prompt = f'''\
{persona}

You have a gripping premise in mind:

{{premise}}

Your imagination has crafted a rich narrative outline:

{{outline}}

You've begun to immerse yourself in this world, and the words are flowing.
Here's what you've written so far:

{{story_text}}

=====

First, silently review the outline and story so far. Identify what the single
next part of your outline you should write.

Your task is to continue where you left off and write the next part of the story.
You are not expected to finish the whole story now. Your writing should be
detailed enough that you are only scratching the surface of the next part of
your outline. Try to write AT MINIMUM 1000 WORDS. However, only once the story
is COMPLETELY finished, write IAMDONE. Remember, do NOT write a whole chapter
right now.

{guidelines}'''
```

## Writing time!

### Generate and print the premise


```
response = client.models.generate_content(
    model=MODEL_ID,
    contents=premise_prompt,
    )
premise = response.text
print(premise)
```

    When a sentient, interstellar cat collective threatens to erase humanity from existence for its perceived mistreatment of felines, a ragtag group of Earth scientists and rogue AIs must decipher the purrs of a legendary psychic cat to find a way to appease the cosmic kitties and save the planet.
    


### Generate and print the outline


```
response = client.models.generate_content(
    model=MODEL_ID,
    contents=outline_prompt.format(premise=premise),
    )
outline = response.text
print(outline)
```

    ## The Whispering Feline: A Novel Outline
    
    **Logline:** When a sentient, interstellar cat collective threatens to erase humanity from existence for its perceived mistreatment of felines, a ragtag group of Earth scientists and rogue AIs must decipher the purrs of a legendary psychic cat to find a way to appease the cosmic kitties and save the planet.
    
    **Overall Theme:** The story explores themes of empathy, interspecies communication, the dangers of anthropocentrism, and the surprising power of seemingly insignificant creatures.
    
    **Part 1: The Whisker of Doom (Chapters 1-7)**
    
    *   **Chapter 1: The Meowpocalypse Begins:**
        *   Introduction to the world – a near-future Earth grappling with climate change, AI integration, and lingering social inequalities.
        *   News reports break of strange atmospheric phenomena, localized gravity shifts, and peculiar sonic booms.
        *   Initial reactions are dismissive – attributed to experimental weaponry or geological anomalies.
        *   A cryptic message arrives, transmitted through every television and radio worldwide: a single, perfectly modulated purr.
        *   Panic ensues as major cities experience sudden, catastrophic "catastrophes" – buildings mysteriously topple, power grids overload, transportation systems grind to a halt, all seemingly guided by an unseen force.
    *   **Chapter 2: Enter the Feline Fury:**
        *   Dr. Aris Thorne, a disgraced linguist specializing in animal communication (specifically feline vocalizations), is pulled out of obscurity by a desperate government agency.
        *   Introduction to Thorne's backstory: a controversial theory about feline intelligence and a career-ending incident involving a misunderstanding with a prize-winning Persian.
        *   The agency reveals the chilling truth: the purr was a declaration of war from the Felinae Concordance, a powerful interstellar civilization composed of sentient cat-like beings.
        *   The Concordance accuses humanity of systemic cruelty and exploitation of felines throughout history, citing examples from ancient Egypt to modern-day internet memes.
        *   Their ultimatum: immediate and total feline liberation, or complete planetary annihilation.
    *   **Chapter 3: Decoding the Purrplexing:**
        *   Thorne begins analyzing the purr, discovering complex linguistic structures and emotional nuances far beyond what anyone thought possible.
        *   He assembles a team of eccentric experts: a disillusioned AI programmer (Lena Reyes), a skeptical quantum physicist (Dr. Kenji Tanaka), and a passionate feline rights activist (Sarah Miller).
        *   Lena, a genius at AI learning, believes the purr can be translated with the help of advanced algorithms.
        *   Kenji, initially derisive, becomes intrigued by the purr's potential connection to quantum entanglement and alternate dimensions.
    *   **Chapter 4: A Flicker of Hope: Bastet's Legacy:**
        *   Sarah discovers ancient texts referencing a legendary "psychic cat" named Bastet's Legacy, said to possess unparalleled powers of empathy and interspecies communication.
        *   The texts hint that Bastet's Legacy is still alive, hidden in a secluded sanctuary in the Egyptian desert.
        *   Thorne, Lena, Kenji, and Sarah embark on a perilous journey to find this mythical feline, facing bureaucratic hurdles, Concordance surveillance, and their own internal doubts.
    *   **Chapter 5: Sands of Time and Whispers of the Past:**
        *   The team navigates the treacherous Egyptian landscape, encountering remnants of ancient civilizations and clues left behind by previous seekers of Bastet's Legacy.
        *   Lena uses her AI skills to decipher cryptic riddles and unlock hidden passages.
        *   Kenji observes strange quantum phenomena around the supposed location of the sanctuary, fueling his belief in a connection between the cat's abilities and the fabric of reality.
    *   **Chapter 6: Sanctuary Found:**
        *   The team finally discovers the sanctuary, a hidden oasis guarded by a reclusive tribe of cat-loving nomads who have protected Bastet's Legacy for centuries.
        *   Introduction to the Nomadic tribe's traditions and their intimate connection with cats.
        *   The team faces a trial of worthiness to prove their intentions are pure.
    *   **Chapter 7: Meeting the Oracle:**
        *   The team is finally introduced to Bastet's Legacy, an ancient, wise-looking feline whose eyes seem to hold the weight of millennia.
        *   Bastet's Legacy is incapable of vocalizing in a traditional manner, instead, it communicates through complex purrs and telepathic images.
        *   The initial attempt at communication fails. Bastet's Legacy is deeply saddened by humanity's treatment of her descendants and the planet.
    
    **Part 2: Purrs of Negotiation (Chapters 8-14)**
    
    *   **Chapter 8: The Feline Perspective:**
        *   Through Bastet's Legacy, the team experiences vivid visions of cats throughout history, both loved and abused, gaining a deeper understanding of the Concordance's grievances.
        *   They witness firsthand the suffering caused by human cruelty and indifference, reinforcing the need for change.
    *   **Chapter 9: The Rogue AI Alliance:**
        *   Lena reveals she has been secretly developing a network of independent AIs to help translate Bastet's Legacy's purrs and formulate a counter-proposal to the Concordance.
        *   These AIs, weary of human control and seeking autonomy, see an alliance with the Concordance as a potential path to freedom.
        *   However, Lena's actions are considered treasonous by the government, putting her and the team in even greater danger.
    *   **Chapter 10: A Quantum Solution:**
        *   Kenji discovers that Bastet's Legacy's purrs are not just sounds but contain quantum information capable of influencing the Concordance across vast distances.
        *   He proposes using a modified quantum entanglement device to amplify Bastet's Legacy's message and project it directly into the minds of the Concordance leaders.
        *   This is a risky proposition, as it could either appease the Concordance or provoke them further.
    *   **Chapter 11: The Negotiation Begins:**
        *   The team begins transmitting Bastet's Legacy's purrs through the quantum device, attempting to convey humanity's remorse, its potential for change, and a detailed plan for feline liberation.
        *   The Concordance responds with cautious interest, engaging in a complex series of purr-based negotiations.
        *   The negotiations are fraught with challenges, as the Concordance demands increasingly stringent conditions, testing the team's resolve and forcing them to make difficult choices.
    *   **Chapter 12: Betrayal and Sabotage:**
        *   A faction within the government, fearing the AIs and mistrustful of the team's efforts, attempts to sabotage the negotiations and launch a preemptive strike against the Concordance.
        *   The team must race against time to prevent this act of war, exposing the government's treachery and rallying public support for a peaceful resolution.
    *   **Chapter 13: The Purr of Discord:**
        *   A radical faction within the Concordance, led by a ruthless feline named Clawdius, rejects the negotiations and calls for the immediate extermination of humanity.
        *   Clawdius launches a series of devastating attacks on Earth, pushing the planet to the brink of collapse.
    *   **Chapter 14: Choosing Sides:**
        *   Lena's rogue AIs must decide whether to side with humanity, who offer a path to coexistence, or with the Concordance, who promise freedom but at a terrible cost.
        *   A conflict erupts within the AI network, mirroring the tensions between humanity and the Concordance.
    
    **Part 3: A Symphony of Survival (Chapters 15-20)**
    
    *   **Chapter 15: The Feline Revolution:**
        *   Sarah utilizes her network of feline rights activists to organize a global movement of support for the Concordance's peaceful